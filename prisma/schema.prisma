generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model AIUsage {
  id           String   @id @default(cuid())
  type         String   // "image_generation", "text_completion", etc.
  model        String   // "dall-e-3", "deepseek-chat", "gpt-4o-mini"
  size         String?  // "1792x1024" (for images)
  cost         Float    // estimated cost in USD
  success      Boolean
  errorMsg     String?
  postId       String?  // optional link to post
  source       String   // "webhook", "admin_approve", "process_content", "translate", etc.
  inputTokens  Int?     // prompt tokens (for text completions)
  outputTokens Int?     // completion tokens (for text completions)
  createdAt    DateTime @default(now())
  Post         Post?    @relation(fields: [postId], references: [id])

  @@index([createdAt])
  @@index([postId])
  @@index([source])
}

model Account {
  id                String       @id
  userId            String
  provider          AuthProvider
  providerAccountId String
  accessToken       String?
  refreshToken      String?
  expiresAt         Int?
  tokenType         String?
  scope             String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime
  User              User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model DigestContent {
  id           String    @id @default(cuid())
  scheduledFor DateTime
  content      String
  postIds      String[]
  topPostId    String
  status       String    @default("PENDING")
  postedAt     DateTime?
  tweetId      String?
  createdAt    DateTime  @default(now())

  @@index([scheduledFor])
  @@index([status])
}

model EmailEvent {
  id                String            @id
  notificationId    String
  event             EmailEventType
  timestamp         DateTime          @default(now())
  metadata          Json?
  EmailNotification EmailNotification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([notificationId])
}

model EmailNotification {
  id         String       @id
  userId     String
  type       EmailType
  subject    String
  postIds    String[]
  status     EmailStatus  @default(PENDING)
  messageId  String?
  error      String?
  sentAt     DateTime?
  createdAt  DateTime     @default(now())
  EmailEvent EmailEvent[]
  User       User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([type, sentAt])
  @@index([userId])
}

model MagicLink {
  id        String   @id
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

model Post {
  id                 String           @id
  sourceId           String           @unique
  source             Source           @default(OFFICIAL)
  sourceUrl          String
  sourceAuthor       String
  sourceDate         DateTime
  originalTitle      String?
  originalContent    String?
  originalMediaUrls  String[]
  translatedTitle    String?
  translatedContent  String?
  translatedSummary  String?
  categories         String[]
  relevanceScore     Int              @default(0)
  status             PostStatus       @default(PENDING)
  publishedToX       Boolean          @default(false)
  xPostId            String?
  xPublishedAt       DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime
  archivedAt         DateTime?
  brand              Brand            @default(INDUSTRY)
  topics             Topic[]
  approvedAt         DateTime?
  digestTweetId      String?
  includedInDigest   Boolean          @default(false)
  cardImageUrl       String?
  publishedToDiscord Boolean?         @default(false)
  discordPublishedAt DateTime?
  AIUsage            AIUsage[]
  PostContent        PostContent?
  PostTranslation    PostTranslation?
  SavedPost          SavedPost[]
  XPublication       XPublication?

  @@index([brand])
  @@index([source])
  @@index([status, archivedAt, createdAt(sort: Desc)], map: "idx_post_active_status_date")
  @@index([createdAt, id], map: "idx_post_cursor")
  @@index([status, includedInDigest, approvedAt], map: "idx_post_digest_eligible")
  @@index([status, relevanceScore(sort: Desc), createdAt], map: "idx_post_publish_queue")
}

model PostArchive {
  id                String    @id
  originalId        String
  archiveMonth      String
  sourceId          String
  source            Source
  sourceUrl         String
  sourceAuthor      String
  sourceDate        DateTime
  brand             Brand
  topics            Topic[]
  relevanceScore    Int
  originalTitle     String?
  originalContent   String
  mediaUrls         String[]
  translatedTitle   String?
  translatedContent String
  translatedSummary String
  tweetId           String?
  tweetUrl          String?
  publishedAt       DateTime?
  likes             Int       @default(0)
  retweets          Int       @default(0)
  replies           Int       @default(0)
  impressions       Int       @default(0)
  createdAt         DateTime
  archivedAt        DateTime  @default(now())

  @@index([archiveMonth])
  @@index([sourceId])
}

model PostContent {
  id          String   @id
  postId      String   @unique
  title       String?
  content     String
  mediaUrls   String[]
  contentHash String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model PostTranslation {
  id           String   @id
  postId       String   @unique
  title        String?
  content      String
  summary      String
  translatedBy String?
  translatedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  Post         Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model PostingLog {
  id        String   @id @default(cuid())
  postType  String
  tweetId   String
  postIds   String[]
  createdAt DateTime @default(now())

  @@index([createdAt])
}

model SavedPost {
  id      String   @id
  userId  String
  postId  String
  savedAt DateTime @default(now())
  Post    Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  User    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
  @@index([userId])
}

model Session {
  id           String   @id
  userId       String
  sessionToken String   @unique
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Subscriber {
  id          String    @id
  email       String    @unique
  language    Language  @default(EN)
  categories  String[]
  frequency   Frequency @default(DAILY)
  verified    Boolean   @default(false)
  verifyToken String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime

  @@index([verified])
}

model User {
  id                String              @id
  email             String              @unique
  name              String?
  avatarUrl         String?
  passwordHash      String?
  emailVerified     Boolean             @default(false)
  emailVerifyToken  String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  role              UserRole            @default(USER)
  Account           Account[]
  EmailNotification EmailNotification[]
  SavedPost         SavedPost[]
  Session           Session[]
  UserPreference    UserPreference?

  @@index([emailVerified])
}

model UserPreference {
  id              String    @id
  userId          String    @unique
  brands          Brand[]
  topics          Topic[]
  digestFrequency Frequency @default(DAILY)
  alertsEnabled   Boolean   @default(true)
  alertThreshold  Int       @default(80)
  language        Language  @default(EN)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  User            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model XPublication {
  id                  String         @id
  postId              String         @unique
  status              XPublishStatus @default(PENDING)
  tweetId             String?
  tweetUrl            String?
  publishedAt         DateTime?
  imageSource         ImageSource    @default(NONE)
  mediaId             String?
  attempts            Int            @default(0)
  lastError           String?
  nextRetryAt         DateTime?
  likes               Int            @default(0)
  retweets            Int            @default(0)
  replies             Int            @default(0)
  impressions         Int            @default(0)
  engagementUpdatedAt DateTime?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime
  Post                Post           @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([status, nextRetryAt], map: "idx_xpub_pending")
}

enum AuthProvider {
  GOOGLE
  GITHUB
}

enum Brand {
  BYD
  NIO
  XPENG
  LI_AUTO
  ZEEKR
  XIAOMI
  TESLA_CHINA
  LEAPMOTOR
  GEELY
  OTHER_BRAND
  INDUSTRY
}

enum EmailEventType {
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  COMPLAINED
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
}

enum EmailType {
  DIGEST
  ALERT
  WELCOME
  VERIFY
}

enum Frequency {
  DAILY
  WEEKLY
  NONE
}

enum ImageSource {
  SCRAPED
  AI_GENERATED
  NONE
  FAILED
}

enum Language {
  EN
  ZH
}

enum PostStatus {
  PENDING
  APPROVED
  PUBLISHED
  REJECTED
}

enum Source {
  OFFICIAL
  MEDIA
  WEIBO
  MANUAL
}

enum Topic {
  DELIVERY
  EARNINGS
  LAUNCH
  TECHNOLOGY
  CHARGING
  POLICY
  EXPANSION
  RECALL
  PARTNERSHIP
  EXECUTIVE
  OTHER
}

enum UserRole {
  USER
  ADMIN
}

enum XPublishStatus {
  PENDING
  PUBLISHING
  PUBLISHED
  FAILED
  SKIPPED
}

// ==========================================
// EV Metrics Enums
// ==========================================

enum MetricType {
  // Sales related
  DELIVERY          // Customer deliveries
  SALES             // Retail sales
  WHOLESALE         // Wholesale sales
  PRODUCTION        // Production volume

  // Battery related
  BATTERY_INSTALL   // Battery installations (GWh)

  // Financial
  REVENUE           // Revenue

  // Market data
  MARKET_SHARE      // Market share percentage
  RANKING           // Ranking position

  // Industry indicators
  IMPORTS           // Import volume
  EXPORTS           // Export volume
  REGISTRATIONS     // License plate registrations
  DEALER_INVENTORY  // Dealer inventory coefficient
}

enum PeriodType {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum VehicleType {
  BEV    // Battery Electric Vehicle
  EREV   // Extended Range Electric Vehicle
  PHEV   // Plug-in Hybrid Electric Vehicle
  HEV    // Hybrid Electric Vehicle
}

enum ScrapeStatus {
  SUCCESS           // Successfully extracted data
  SKIPPED_DUPLICATE // Skipped as duplicate
  SKIPPED_NO_DATA   // No extractable data
  SKIPPED_PAYWALL   // Requires subscription
  FAILED            // Extraction failed
  PENDING           // Pending processing
}

// ==========================================
// EV Metrics Tables
// ==========================================

model EVMetric {
  id          String      @id @default(cuid())

  // Dimension fields
  brand       Brand                    // Brand (INDUSTRY for industry-level data)
  metric      MetricType               // Metric type
  periodType  PeriodType               // Period type
  year        Int                      // Year
  period      Int                      // Period: 1-12 for monthly, 1-4 for quarterly, 1 for yearly

  // Optional dimensions (for granular data)
  vehicleModel String?                 // Vehicle model: "Model 3", "Model Y", "Han EV"
  region      String?                  // Region: "Shanghai", "Beijing", "Guangdong"
  category    String?                  // Category: "NEV", "BEV", "PHEV", "Passenger", "Commercial"
  dataSource  String?                  // Data source: "OFFICIAL", "CPCA", "CAAM", "ESTIMATE"

  // Value fields
  value       Float                    // Primary value
  unit        String?                  // Unit: vehicles, GWh, USD million, ratio
  yoyChange   Float?                   // Year-over-year change %
  momChange   Float?                   // Month-over-month change % (or QoQ)
  marketShare Float?                   // Market share %
  ranking     Int?                     // Ranking

  // Source tracking
  sourceUrl   String?
  sourceTitle String?
  confidence  Float       @default(1.0) // Data confidence (OCR may be < 1)

  // Timestamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  sources     EVMetricSource[]

  // Unique constraint
  @@unique([brand, metric, periodType, year, period, vehicleModel, region, category, dataSource])

  // Indexes
  @@index([brand])
  @@index([metric])
  @@index([periodType, year, period])
  @@index([year, period])
  @@index([region])
  @@index([vehicleModel])
  @@index([brand, metric, year], map: "idx_brand_metric_year")
}

model EVMetricSource {
  id          String    @id @default(cuid())
  metricId    String
  metric      EVMetric  @relation(fields: [metricId], references: [id], onDelete: Cascade)

  sourceType  String    // TITLE_PARSE, SUMMARY_PARSE, IMAGE_OCR, MANUAL
  rawText     String?   // Raw text
  imageUrl    String?   // Image URL (if OCR)
  parseLog    Json?     // Parse log

  createdAt   DateTime  @default(now())

  @@index([metricId])
}

// ==========================================
// Scrape Tracking Table (deduplication)
// ==========================================

model ScrapedArticle {
  id            String        @id @default(cuid())

  // Article identifier (for deduplication)
  sourceUrl     String        @unique    // Article URL, unique constraint
  urlHash       String        @unique    // MD5 hash of URL, backup dedup

  // Article metadata
  title         String
  summary       String?
  publishedAt   DateTime?
  previewImage  String?                  // Preview image URL

  // Processing status
  status        ScrapeStatus  @default(PENDING)
  articleType   String?                  // BRAND_METRIC, VEHICLE_SPEC, etc.
  needsOcr      Boolean       @default(false)
  ocrCompleted  Boolean       @default(false)

  // Extraction results
  extractedData Json?                    // Extracted raw data
  metricsCount  Int           @default(0) // Records written to EVMetric
  specsCount    Int           @default(0) // Records written to VehicleSpec

  // Error tracking
  errorMessage  String?
  retryCount    Int           @default(0)

  // Timestamps
  scrapedAt     DateTime      @default(now())
  processedAt   DateTime?
  updatedAt     DateTime      @updatedAt

  // Indexes
  @@index([status])
  @@index([scrapedAt])
  @@index([articleType])
}

// ==========================================
// Vehicle Specs Table
// ==========================================

model VehicleSpec {
  id              String      @id @default(cuid())

  // Vehicle identification
  brand           Brand                    // Brand
  model           String                   // Model name: "Li L9", "NIO EC7", "Model Y"
  variant         String                   // Variant: "Air", "Pro", "Max", "Long Range"

  // Basic info
  launchDate      String?                  // Launch date "202302"
  vehicleType     VehicleType?             // BEV, EREV, PHEV
  segment         String?                  // "SUV", "Sedan", "MPV"

  // Price (RMB)
  startingPrice   Float?                   // Starting price
  currentPrice    Float?                   // Current price (may have changed)

  // Dimensions (mm)
  lengthMm        Int?
  widthMm         Int?
  heightMm        Int?
  wheelbaseMm     Int?

  // Performance
  acceleration    Float?                   // 0-100km/h seconds
  topSpeed        Int?                     // Top speed km/h
  motorPowerKw    Int?                     // Motor power kW
  motorTorqueNm   Int?                     // Motor torque Nm

  // Battery & Range
  batteryCapacity Float?                   // Battery capacity kWh
  rangeCltc       Int?                     // CLTC range km
  rangeWltp       Int?                     // WLTP range km
  rangeEpa        Int?                     // EPA range km

  // EREV/PHEV specific
  fuelTankVolume  Float?                   // Fuel tank volume L
  engineDisplacement Float?                // Engine displacement L

  // Charging
  maxChargingPower Int?                    // Max charging power kW
  chargingTime10To80 Int?                  // 10-80% charging time minutes

  // Source tracking
  sourceUrl       String?
  confidence      Float       @default(1.0)
  sources         VehicleSpecSource[]

  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Unique constraint
  @@unique([brand, model, variant])

  // Indexes
  @@index([brand])
  @@index([model])
  @@index([vehicleType])
  @@index([brand, segment])
}

model VehicleSpecSource {
  id          String      @id @default(cuid())
  specId      String
  spec        VehicleSpec @relation(fields: [specId], references: [id], onDelete: Cascade)

  sourceType  String      // IMAGE_OCR, MANUAL
  rawText     String?
  imageUrl    String?
  parseLog    Json?

  createdAt   DateTime    @default(now())

  @@index([specId])
}
