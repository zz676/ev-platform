generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model AIUsage {
  id           String   @id @default(cuid())
  type         String   // "image_generation", "text_completion", etc.
  model        String   // "dall-e-3", "deepseek-chat", "gpt-4o-mini"
  size         String?  // "1792x1024" (for images)
  cost         Float    // estimated cost in USD
  success      Boolean
  errorMsg     String?
  postId       String?  // optional link to post
  source       String   // "webhook", "admin_approve", "process_content", "translate", etc.
  inputTokens  Int?     // prompt tokens (for text completions)
  outputTokens Int?     // completion tokens (for text completions)
  createdAt    DateTime @default(now())
  Post         Post?    @relation(fields: [postId], references: [id])

  @@index([createdAt])
  @@index([postId])
  @@index([source])
}

model Account {
  id                String       @id
  userId            String
  provider          AuthProvider
  providerAccountId String
  accessToken       String?
  refreshToken      String?
  expiresAt         Int?
  tokenType         String?
  scope             String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime
  User              User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model DigestContent {
  id           String    @id @default(cuid())
  scheduledFor DateTime
  content      String
  postIds      String[]
  topPostId    String
  status       String    @default("PENDING")
  postedAt     DateTime?
  tweetId      String?
  createdAt    DateTime  @default(now())

  @@index([scheduledFor])
  @@index([status])
}

model EmailEvent {
  id                String            @id
  notificationId    String
  event             EmailEventType
  timestamp         DateTime          @default(now())
  metadata          Json?
  EmailNotification EmailNotification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([notificationId])
}

model EmailNotification {
  id         String       @id
  userId     String
  type       EmailType
  subject    String
  postIds    String[]
  status     EmailStatus  @default(PENDING)
  messageId  String?
  error      String?
  sentAt     DateTime?
  createdAt  DateTime     @default(now())
  EmailEvent EmailEvent[]
  User       User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([type, sentAt])
  @@index([userId])
}

model MagicLink {
  id        String   @id
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

model Post {
  id                 String           @id
  sourceId           String           @unique
  source             Source           @default(OFFICIAL)
  sourceUrl          String
  sourceAuthor       String
  sourceDate         DateTime
  originalTitle      String?
  originalContent    String?
  originalMediaUrls  String[]
  translatedTitle    String?
  translatedContent  String?
  translatedSummary  String?
  categories         String[]
  relevanceScore     Int              @default(0)
  status             PostStatus       @default(PENDING)
  publishedToX       Boolean          @default(false)
  xPostId            String?
  xPublishedAt       DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime
  archivedAt         DateTime?
  brand              Brand            @default(INDUSTRY)
  topics             Topic[]
  approvedAt         DateTime?
  digestTweetId      String?
  includedInDigest   Boolean          @default(false)
  cardImageUrl       String?
  publishedToDiscord Boolean?         @default(false)
  discordPublishedAt DateTime?
  AIUsage            AIUsage[]
  PostContent        PostContent?
  PostTranslation    PostTranslation?
  SavedPost          SavedPost[]
  XPublication       XPublication?

  @@index([brand])
  @@index([source])
  @@index([status, archivedAt, createdAt(sort: Desc)], map: "idx_post_active_status_date")
  @@index([createdAt, id], map: "idx_post_cursor")
  @@index([status, includedInDigest, approvedAt], map: "idx_post_digest_eligible")
  @@index([status, relevanceScore(sort: Desc), createdAt], map: "idx_post_publish_queue")
}

model PostArchive {
  id                String    @id
  originalId        String
  archiveMonth      String
  sourceId          String
  source            Source
  sourceUrl         String
  sourceAuthor      String
  sourceDate        DateTime
  brand             Brand
  topics            Topic[]
  relevanceScore    Int
  originalTitle     String?
  originalContent   String
  mediaUrls         String[]
  translatedTitle   String?
  translatedContent String
  translatedSummary String
  tweetId           String?
  tweetUrl          String?
  publishedAt       DateTime?
  likes             Int       @default(0)
  retweets          Int       @default(0)
  replies           Int       @default(0)
  impressions       Int       @default(0)
  createdAt         DateTime
  archivedAt        DateTime  @default(now())

  @@index([archiveMonth])
  @@index([sourceId])
}

model PostContent {
  id          String   @id
  postId      String   @unique
  title       String?
  content     String
  mediaUrls   String[]
  contentHash String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model PostTranslation {
  id           String   @id
  postId       String   @unique
  title        String?
  content      String
  summary      String
  translatedBy String?
  translatedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  Post         Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model PostingLog {
  id        String   @id @default(cuid())
  postType  String
  tweetId   String
  postIds   String[]
  createdAt DateTime @default(now())

  @@index([createdAt])
}

model SavedPost {
  id      String   @id
  userId  String
  postId  String
  savedAt DateTime @default(now())
  Post    Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  User    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
  @@index([userId])
}

model Session {
  id           String   @id
  userId       String
  sessionToken String   @unique
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Subscriber {
  id          String    @id
  email       String    @unique
  language    Language  @default(EN)
  categories  String[]
  frequency   Frequency @default(DAILY)
  verified    Boolean   @default(false)
  verifyToken String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime

  @@index([verified])
}

model User {
  id                String              @id
  email             String              @unique
  name              String?
  avatarUrl         String?
  passwordHash      String?
  emailVerified     Boolean             @default(false)
  emailVerifyToken  String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  role              UserRole            @default(USER)
  Account           Account[]
  EmailNotification EmailNotification[]
  SavedPost         SavedPost[]
  Session           Session[]
  UserPreference    UserPreference?
  XAccount          XAccount?

  @@index([emailVerified])
}

model UserPreference {
  id              String    @id
  userId          String    @unique
  brands          Brand[]
  topics          Topic[]
  digestFrequency Frequency @default(DAILY)
  alertsEnabled   Boolean   @default(true)
  alertThreshold  Int       @default(80)
  language        Language  @default(EN)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  User            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model XPublication {
  id                  String         @id
  postId              String         @unique
  status              XPublishStatus @default(PENDING)
  tweetId             String?
  tweetUrl            String?
  publishedAt         DateTime?
  imageSource         ImageSource    @default(NONE)
  mediaId             String?
  attempts            Int            @default(0)
  lastError           String?
  nextRetryAt         DateTime?
  likes               Int            @default(0)
  retweets            Int            @default(0)
  replies             Int            @default(0)
  impressions         Int            @default(0)
  engagementUpdatedAt DateTime?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime
  Post                Post           @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([status, nextRetryAt], map: "idx_xpub_pending")
}

model XAccount {
  id             String   @id @default(cuid())
  userId         String   @unique
  xUserId        String   @unique
  username       String
  displayName    String?
  avatarUrl      String?
  accessToken    String
  refreshToken   String
  tokenExpiresAt DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  User           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum AuthProvider {
  GOOGLE
  GITHUB
  TWITTER
}

enum Brand {
  BYD
  NIO
  XPENG
  LI_AUTO
  ZEEKR
  XIAOMI
  TESLA_CHINA
  LEAPMOTOR
  GEELY
  OTHER_BRAND
  INDUSTRY
}

enum EmailEventType {
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  COMPLAINED
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
}

enum EmailType {
  DIGEST
  ALERT
  WELCOME
  VERIFY
}

enum Frequency {
  DAILY
  WEEKLY
  NONE
}

enum ImageSource {
  SCRAPED
  AI_GENERATED
  NONE
  FAILED
}

enum Language {
  EN
  ZH
}

enum PostStatus {
  PENDING
  APPROVED
  PUBLISHED
  REJECTED
}

enum Source {
  OFFICIAL
  MEDIA
  WEIBO
  MANUAL
}

enum Topic {
  DELIVERY
  EARNINGS
  LAUNCH
  TECHNOLOGY
  CHARGING
  POLICY
  EXPANSION
  RECALL
  PARTNERSHIP
  EXECUTIVE
  OTHER
}

enum UserRole {
  USER
  ADMIN
}

enum XPublishStatus {
  PENDING
  PUBLISHING
  PUBLISHED
  FAILED
  SKIPPED
}

// ==========================================
// Metric Posts for X (Data-Driven Posts)
// ==========================================

enum MetricPostType {
  BRAND_TREND          // 12-month trend for single brand
  ALL_BRANDS_COMPARISON // All brands for single month
}

enum MetricPostStatus {
  PENDING
  POSTED
  FAILED
}

model MetricPost {
  id            String           @id @default(cuid())
  postType      MetricPostType   // Type of metric post
  year          Int              // Target year for the post
  period        Int?             // Month 1-12 (for ALL_BRANDS_COMPARISON)
  brand         Brand?           // Only for BRAND_TREND
  content       String           // Generated tweet content
  chartImageUrl String?          // URL of the chart image (stored in Vercel Blob)
  status        MetricPostStatus @default(PENDING)
  tweetId       String?          // X tweet ID after posting
  postedAt      DateTime?        // When posted to X
  dataSnapshot  Json?            // Raw data at generation time
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@unique([postType, year, period, brand])
  @@index([year, period])
  @@index([status])
}

// ==========================================
// EV Metrics Enums
// ==========================================

enum MetricType {
  // Sales related
  DELIVERY          // Customer deliveries
  SALES             // Retail sales
  WHOLESALE         // Wholesale sales
  PRODUCTION        // Production volume

  // Battery related
  BATTERY_INSTALL   // Battery installations (GWh)

  // Financial
  REVENUE           // Revenue

  // Market data
  MARKET_SHARE      // Market share percentage
  RANKING           // Ranking position

  // Industry indicators
  IMPORTS           // Import volume
  EXPORTS           // Export volume
  REGISTRATIONS     // License plate registrations
  DEALER_INVENTORY  // Dealer inventory coefficient
}

enum PeriodType {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum VehicleType {
  BEV    // Battery Electric Vehicle
  EREV   // Extended Range Electric Vehicle
  PHEV   // Plug-in Hybrid Electric Vehicle
  HEV    // Hybrid Electric Vehicle
}

enum ScrapeStatus {
  SUCCESS           // Successfully extracted data
  SKIPPED_DUPLICATE // Skipped as duplicate
  SKIPPED_NO_DATA   // No extractable data
  SKIPPED_PAYWALL   // Requires subscription
  FAILED            // Extraction failed
  PENDING           // Pending processing
}

// ==========================================
// EV Metrics Tables
// ==========================================

model EVMetric {
  id          String      @id @default(cuid())

  // Dimension fields
  brand       Brand                    // Brand (INDUSTRY for industry-level data)
  metric      MetricType               // Metric type
  periodType  PeriodType               // Period type
  year        Int                      // Year
  period      Int                      // Period: 1-12 for monthly, 1-4 for quarterly, 1 for yearly

  // Optional dimensions (for granular data)
  vehicleModel String?                 // Vehicle model: "Model 3", "Model Y", "Han EV"
  region      String?                  // Region: "Shanghai", "Beijing", "Guangdong"
  category    String?                  // Category: "NEV", "BEV", "PHEV", "Passenger", "Commercial"
  dataSource  String?                  // Data source: "OFFICIAL", "CPCA", "CAAM", "ESTIMATE"

  // Value fields
  value       Float                    // Primary value
  unit        String?                  // Unit: vehicles, GWh, USD million, ratio
  yoyChange   Float?                   // Year-over-year change %
  momChange   Float?                   // Month-over-month change % (or QoQ)
  marketShare Float?                   // Market share %
  ranking     Int?                     // Ranking

  // Source tracking
  sourceUrl   String?
  sourceTitle String?
  confidence  Float       @default(1.0) // Data confidence (OCR may be < 1)

  // Timestamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  sources     EVMetricSource[]

  // Unique constraint
  @@unique([brand, metric, periodType, year, period, vehicleModel, region, category, dataSource])

  // Indexes
  @@index([brand])
  @@index([metric])
  @@index([periodType, year, period])
  @@index([year, period])
  @@index([region])
  @@index([vehicleModel])
  @@index([brand, metric, year], map: "idx_brand_metric_year")
}

model EVMetricSource {
  id          String    @id @default(cuid())
  metricId    String
  metric      EVMetric  @relation(fields: [metricId], references: [id], onDelete: Cascade)

  sourceType  String    // TITLE_PARSE, SUMMARY_PARSE, IMAGE_OCR, MANUAL
  rawText     String?   // Raw text
  imageUrl    String?   // Image URL (if OCR)
  parseLog    Json?     // Parse log

  createdAt   DateTime  @default(now())

  @@index([metricId])
}

// ==========================================
// Scrape Tracking Table (deduplication)
// ==========================================

model ScrapedArticle {
  id            String        @id @default(cuid())

  // Article identifier (for deduplication)
  sourceUrl     String        @unique    // Article URL, unique constraint
  urlHash       String        @unique    // MD5 hash of URL, backup dedup

  // Article metadata
  title         String
  summary       String?
  publishedAt   DateTime?
  previewImage  String?                  // Preview image URL

  // Time period (extracted from title)
  month         Int?                     // 1-12, extracted from title
  year          Int?                     // Year extracted from title

  // Processing status
  status        ScrapeStatus  @default(PENDING)
  articleType   String?                  // BRAND_METRIC, VEHICLE_SPEC, etc.
  needsOcr      Boolean       @default(false)
  ocrCompleted  Boolean       @default(false)

  // Extraction results
  extractedData Json?                    // Extracted raw data
  metricsCount  Int           @default(0) // Records written to EVMetric
  specsCount    Int           @default(0) // Records written to VehicleSpec

  // Error tracking
  errorMessage  String?
  retryCount    Int           @default(0)

  // Timestamps
  scrapedAt     DateTime      @default(now())
  processedAt   DateTime?
  updatedAt     DateTime      @updatedAt

  // Indexes
  @@index([status])
  @@index([scrapedAt])
  @@index([articleType])
  @@index([month, year])
}

// ==========================================
// Vehicle Specs Table
// ==========================================

model VehicleSpec {
  id              String      @id @default(cuid())

  // Vehicle identification
  brand           Brand                    // Brand
  model           String                   // Model name: "Li L9", "NIO EC7", "Model Y"
  variant         String                   // Variant: "Air", "Pro", "Max", "Long Range"

  // Basic info
  launchDate      String?                  // Launch date "202302"
  vehicleType     VehicleType?             // BEV, EREV, PHEV
  segment         String?                  // "SUV", "Sedan", "MPV"

  // Price (RMB)
  startingPrice   Float?                   // Starting price
  currentPrice    Float?                   // Current price (may have changed)

  // Dimensions (mm)
  lengthMm        Int?
  widthMm         Int?
  heightMm        Int?
  wheelbaseMm     Int?

  // Performance
  acceleration    Float?                   // 0-100km/h seconds
  topSpeed        Int?                     // Top speed km/h
  motorPowerKw    Int?                     // Motor power kW
  motorTorqueNm   Int?                     // Motor torque Nm

  // Battery & Range
  batteryCapacity Float?                   // Battery capacity kWh
  rangeCltc       Int?                     // CLTC range km
  rangeWltp       Int?                     // WLTP range km
  rangeEpa        Int?                     // EPA range km

  // EREV/PHEV specific
  fuelTankVolume  Float?                   // Fuel tank volume L
  engineDisplacement Float?                // Engine displacement L

  // Charging
  maxChargingPower Int?                    // Max charging power kW
  chargingTime10To80 Int?                  // 10-80% charging time minutes

  // Source tracking
  sourceUrl       String?
  confidence      Float       @default(1.0)
  sources         VehicleSpecSource[]

  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Unique constraint
  @@unique([brand, model, variant])

  // Indexes
  @@index([brand])
  @@index([model])
  @@index([vehicleType])
  @@index([brand, segment])
}

model VehicleSpecSource {
  id          String      @id @default(cuid())
  specId      String
  spec        VehicleSpec @relation(fields: [specId], references: [id], onDelete: Cascade)

  sourceType  String      // IMAGE_OCR, MANUAL
  rawText     String?
  imageUrl    String?
  parseLog    Json?

  createdAt   DateTime    @default(now())

  @@index([specId])
}

// ==========================================
// Industry Data Tables - Time Series
// ==========================================

/// Monthly China passenger car inventory levels from CPCA (China Passenger Car Association).
/// Tracks total inventory at dealerships and manufacturers across China.
/// Used to monitor supply-demand balance in China's automotive market.
/// Data frequency: Monthly
/// Primary source: CPCA reports
/// Use case: Analyze inventory trends, predict production adjustments, assess market health
model ChinaPassengerInventory {
  /// Unique identifier (CUID format)
  id            String   @id @default(cuid())

  /// Calendar year (e.g., 2024, 2025)
  year          Int

  /// Month of the year (1-12, where 1=January, 12=December)
  month         Int

  /// Inventory level in million units (e.g., 3.2 means 3.2 million vehicles in inventory)
  value         Float

  /// Unit of measurement. Default: "million_units"
  unit          String   @default("million_units")

  /// Optional summary or context from the source article
  description   String?

  /// URL of the source article where data was extracted
  sourceUrl     String

  /// Title of the source article
  sourceTitle   String

  /// URL of any chart/image used for OCR extraction (if applicable)
  imageUrl      String?

  /// Record creation timestamp
  createdAt     DateTime @default(now())

  /// Last update timestamp
  updatedAt     DateTime @updatedAt

  @@unique([year, month])
  @@index([year, month])
}

/// Monthly China power battery installation and production data.
/// Tracks batteries installed in EVs (installation) and total production by Chinese battery industry.
/// Installation typically differs from production as batteries may be exported or stockpiled.
/// Data frequency: Monthly
/// Primary source: CABIA (China Automotive Battery Innovation Alliance)
/// Use case: Track EV adoption, battery industry growth, supply chain dynamics
model ChinaBatteryInstallation {
  /// Unique identifier (CUID format)
  id            String   @id @default(cuid())

  /// Calendar year (e.g., 2024, 2025)
  year          Int

  /// Month of the year (1-12, where 1=January, 12=December)
  month         Int

  /// Battery installed in vehicles during the month (GWh). This is the primary metric for EV adoption.
  installation  Float

  /// Battery produced during the month (GWh). May exceed installation due to exports/inventory buildup.
  production    Float?

  /// Unit of measurement. Default: "GWh" (Gigawatt-hours)
  unit          String   @default("GWh")

  /// Optional summary or context from the source article
  description   String?

  /// URL of the source article where data was extracted
  sourceUrl     String

  /// Title of the source article
  sourceTitle   String

  /// URL of any chart/image used for OCR extraction (if applicable)
  imageUrl      String?

  /// Record creation timestamp
  createdAt     DateTime @default(now())

  /// Last update timestamp
  updatedAt     DateTime @updatedAt

  @@unique([year, month])
  @@index([year, month])
}

/// Monthly NEV (New Energy Vehicle) sales statistics from CAAM.
/// CAAM (China Association of Automobile Manufacturers) is the official industry body.
/// CAAM data typically includes both domestic sales and exports, representing total production sold.
/// Data frequency: Monthly
/// Primary source: CAAM official releases
/// Use case: Track total NEV market size, compare with CPCA retail data
model CaamNevSales {
  /// Unique identifier (CUID format)
  id            String   @id @default(cuid())

  /// Calendar year (e.g., 2024, 2025)
  year          Int

  /// Month of the year (1-12, where 1=January, 12=December)
  month         Int

  /// Total NEV sales volume in number of vehicles
  value         Float

  /// Unit of measurement. Default: "vehicles"
  unit          String   @default("vehicles")

  /// Year-over-year percentage change (e.g., 25.5 means +25.5% vs same month last year)
  yoyChange     Float?

  /// Month-over-month percentage change (e.g., -10.2 means -10.2% vs previous month)
  momChange     Float?

  /// Optional summary or context from the source article
  description   String?

  /// URL of the source article where data was extracted
  sourceUrl     String

  /// Title of the source article
  sourceTitle   String

  /// URL of any chart/image used for OCR extraction (if applicable)
  imageUrl      String?

  /// Record creation timestamp
  createdAt     DateTime @default(now())

  /// Last update timestamp
  updatedAt     DateTime @updatedAt

  @@unique([year, month])
  @@index([year, month])
}

/// Monthly dealer inventory coefficient (库存系数) for China's auto market.
/// The inventory coefficient represents months of inventory at dealerships.
/// Interpretation: 1.0 = 1 month of stock, 1.5+ = oversupply/weak demand, <0.8 = shortage/strong demand
/// Healthy range is typically 0.8-1.2. Above 1.5 signals market pressure on dealers.
/// Data frequency: Monthly
/// Primary source: China Automobile Dealers Association (CADA)
/// Use case: Assess dealer health, predict pricing pressure, market demand signals
model ChinaDealerInventoryFactor {
  /// Unique identifier (CUID format)
  id            String   @id @default(cuid())

  /// Calendar year (e.g., 2024, 2025)
  year          Int

  /// Month of the year (1-12, where 1=January, 12=December)
  month         Int

  /// Inventory coefficient ratio (e.g., 1.31 = 1.31 months of inventory on hand)
  /// Values >1.5 indicate oversupply, <0.8 indicate shortage
  value         Float

  /// Unit of measurement. Default: "ratio"
  unit          String   @default("ratio")

  /// Optional summary or context from the source article
  description   String?

  /// URL of the source article where data was extracted
  sourceUrl     String

  /// Title of the source article
  sourceTitle   String

  /// URL of any chart/image used for OCR extraction (if applicable)
  imageUrl      String?

  /// Record creation timestamp
  createdAt     DateTime @default(now())

  /// Last update timestamp
  updatedAt     DateTime @updatedAt

  @@unique([year, month])
  @@index([year, month])
}

/// Monthly NEV retail sales from CPCA (China Passenger Car Association).
/// Retail sales = units sold to end consumers (registered for road use).
/// Differs from wholesale: retail reflects actual consumer demand, wholesale reflects dealer orders.
/// CPCA data focuses on passenger vehicles; excludes commercial vehicles.
/// Data frequency: Monthly
/// Primary source: CPCA official releases
/// Use case: Track consumer EV adoption, compare with wholesale to assess channel inventory
model CpcaNevRetail {
  /// Unique identifier (CUID format)
  id            String   @id @default(cuid())

  /// Calendar year (e.g., 2024, 2025)
  year          Int

  /// Month of the year (1-12, where 1=January, 12=December)
  month         Int

  /// NEV units sold to end consumers (retail registrations)
  value         Float

  /// Unit of measurement. Default: "vehicles"
  unit          String   @default("vehicles")

  /// Year-over-year percentage change (e.g., 25.5 means +25.5% vs same month last year)
  yoyChange     Float?

  /// Month-over-month percentage change (e.g., -10.2 means -10.2% vs previous month)
  momChange     Float?

  /// Optional summary or context from the source article
  description   String?

  /// URL of the source article where data was extracted
  sourceUrl     String

  /// Title of the source article
  sourceTitle   String

  /// URL of any chart/image used for OCR extraction (if applicable)
  imageUrl      String?

  /// Record creation timestamp
  createdAt     DateTime @default(now())

  /// Last update timestamp
  updatedAt     DateTime @updatedAt

  @@unique([year, month])
  @@index([year, month])
}

/// Monthly NEV production volume from CPCA (China Passenger Car Association).
/// Production = units manufactured by automakers during the month.
/// Production typically leads sales data; comparing production vs sales shows inventory build/draw.
/// CPCA data focuses on passenger vehicles; excludes commercial vehicles.
/// Data frequency: Monthly
/// Primary source: CPCA official releases
/// Use case: Track manufacturing output, predict future supply, compare with sales
model CpcaNevProduction {
  /// Unique identifier (CUID format)
  id            String   @id @default(cuid())

  /// Calendar year (e.g., 2024, 2025)
  year          Int

  /// Month of the year (1-12, where 1=January, 12=December)
  month         Int

  /// NEV units produced by manufacturers
  value         Float

  /// Unit of measurement. Default: "vehicles"
  unit          String   @default("vehicles")

  /// Year-over-year percentage change (e.g., 25.5 means +25.5% vs same month last year)
  yoyChange     Float?

  /// Month-over-month percentage change (e.g., -10.2 means -10.2% vs previous month)
  momChange     Float?

  /// Optional summary or context from the source article
  description   String?

  /// URL of the source article where data was extracted
  sourceUrl     String

  /// Title of the source article
  sourceTitle   String

  /// URL of any chart/image used for OCR extraction (if applicable)
  imageUrl      String?

  /// Record creation timestamp
  createdAt     DateTime @default(now())

  /// Last update timestamp
  updatedAt     DateTime @updatedAt

  @@unique([year, month])
  @@index([year, month])
}

/// Monthly Vehicle Inventory Alert Index (汽车经销商库存预警指数) - market health indicator.
/// The VIA Index works like PMI: >50% indicates contraction/pessimism, <50% indicates expansion/optimism.
/// Interpretation: 50% = neutral, 60%+ = significant dealer stress, <45% = healthy/optimistic market
/// This is a sentiment and inventory pressure indicator surveyed from dealers.
/// Data frequency: Monthly
/// Primary source: China Automobile Dealers Association (CADA)
/// Use case: Gauge dealer confidence, predict market trends, assess inventory pressure
model ChinaViaIndex {
  /// Unique identifier (CUID format)
  id            String   @id @default(cuid())

  /// Calendar year (e.g., 2024, 2025)
  year          Int

  /// Month of the year (1-12, where 1=January, 12=December)
  month         Int

  /// VIA Index percentage (e.g., 59.4 = 59.4%)
  /// >50% = contraction/pressure, <50% = expansion/healthy (inverse of typical PMI interpretation)
  value         Float

  /// Unit of measurement. Default: "percent"
  unit          String   @default("percent")

  /// Contextual interpretation (e.g., "automotive industry remains in contraction territory")
  description   String?

  /// URL of the source article where data was extracted
  sourceUrl     String

  /// Title of the source article
  sourceTitle   String

  /// URL of any chart/image used for OCR extraction (if applicable)
  imageUrl      String?

  /// Record creation timestamp
  createdAt     DateTime @default(now())

  /// Last update timestamp
  updatedAt     DateTime @updatedAt

  @@unique([year, month])
  @@index([year, month])
}

// ==========================================
// Industry Data Tables - Entity-Specific Time Series
// ==========================================

/// Monthly battery data by specific battery maker (individual company performance).
/// Tracks installation and production volumes for major battery manufacturers.
/// Major makers: CATL, BYD, LG Energy Solution, SK On, Panasonic, CALB, Gotion (Guoxuan), EVE, Sunwoda
/// Data frequency: Monthly
/// Primary source: CABIA (China), SNE Research (Global)
/// Use case: Track individual battery company performance, market share trends, competitive analysis
model BatteryMakerMonthly {
  /// Unique identifier (CUID format)
  id            String   @id @default(cuid())

  /// Battery maker company name. Common values:
  /// Chinese: "CATL", "BYD", "CALB", "Gotion", "EVE", "Sunwoda"
  /// Global: "LG", "SK", "Panasonic", "Samsung SDI"
  maker         String

  /// Calendar year (e.g., 2024, 2025)
  year          Int

  /// Month of the year (1-12, where 1=January, 12=December)
  month         Int

  /// Battery installed in vehicles during the month (GWh)
  installation  Float

  /// Battery produced during the month (GWh). May differ from installation.
  production    Float?

  /// Unit of measurement. Default: "GWh" (Gigawatt-hours)
  unit          String   @default("GWh")

  /// Year-over-year percentage change (e.g., 25.5 means +25.5% vs same month last year)
  yoyChange     Float?

  /// Month-over-month percentage change (e.g., -10.2 means -10.2% vs previous month)
  momChange     Float?

  /// Optional summary or context from the source article
  description   String?

  /// URL of the source article where data was extracted
  sourceUrl     String

  /// Title of the source article
  sourceTitle   String

  /// URL of any chart/image used for OCR extraction (if applicable)
  imageUrl      String?

  /// Record creation timestamp
  createdAt     DateTime @default(now())

  /// Last update timestamp
  updatedAt     DateTime @updatedAt

  @@unique([maker, year, month])
  @@index([maker])
  @@index([year, month])
}

/// Monthly export data by manufacturing plant (factory-level exports).
/// Tracks vehicles exported from specific manufacturing facilities.
/// Key plants: Tesla Gigafactory Shanghai, BYD Shenzhen, NIO Hefei, etc.
/// Useful for understanding export hub performance and regional production strategy.
/// Data frequency: Monthly
/// Primary source: China Customs, company announcements
/// Use case: Track export performance by plant, supply chain analysis, regional production trends
model PlantExports {
  /// Unique identifier (CUID format)
  id            String   @id @default(cuid())

  /// Plant identifier. Format: "BRAND_LOCATION"
  /// Examples: "TESLA_SHANGHAI", "BYD_SHENZHEN", "NIO_HEFEI", "XPENG_ZHAOQING"
  plant         String

  /// Parent brand/company name (e.g., "TESLA", "BYD", "NIO")
  brand         String

  /// Calendar year (e.g., 2024, 2025)
  year          Int

  /// Month of the year (1-12, where 1=January, 12=December)
  month         Int

  /// Number of vehicles exported from this plant
  value         Float

  /// Unit of measurement. Default: "vehicles"
  unit          String   @default("vehicles")

  /// Year-over-year percentage change (e.g., 25.5 means +25.5% vs same month last year)
  yoyChange     Float?

  /// Month-over-month percentage change (e.g., -10.2 means -10.2% vs previous month)
  momChange     Float?

  /// Optional summary or context from the source article
  description   String?

  /// URL of the source article where data was extracted
  sourceUrl     String

  /// Title of the source article
  sourceTitle   String

  /// URL of any chart/image used for OCR extraction (if applicable)
  imageUrl      String?

  /// Record creation timestamp
  createdAt     DateTime @default(now())

  /// Last update timestamp
  updatedAt     DateTime @updatedAt

  @@unique([plant, year, month])
  @@index([plant])
  @@index([brand])
  @@index([year, month])
}

// ==========================================
// Industry Data Tables - Rankings/Tables
// ==========================================

/// NEV sales summary for a specific date range (typically weekly or bi-weekly reports).
/// CPCA releases weekly sales estimates during the month before full monthly data.
/// Contains both retail (to consumers) and wholesale (to dealers) figures for comparison.
/// Retail-wholesale gap indicates channel inventory changes.
/// Data frequency: Weekly or bi-weekly
/// Primary source: CPCA weekly flash reports
/// Use case: Early month-to-date sales tracking, weekly trends, retail vs wholesale analysis
model NevSalesSummary {
  /// Unique identifier (CUID format)
  id             String   @id @default(cuid())

  /// Data source organization. Default: "CPCA"
  /// Values: "CPCA", "CAAM"
  dataSource     String   @default("CPCA")

  /// Calendar year (e.g., 2024, 2025)
  year           Int

  /// Start date of the reporting period. Format: "YYYY-MM-DD" (e.g., "2025-01-01")
  startDate      String

  /// End date of the reporting period. Format: "YYYY-MM-DD" (e.g., "2025-01-18")
  endDate        String

  /// NEV retail sales (units sold to end consumers) during the period
  retailSales    Float

  /// Retail year-over-year percentage change vs same period last year
  retailYoy      Float?

  /// Retail change vs previous comparable period (e.g., previous week)
  retailMom      Float?

  /// NEV wholesale sales (units sold to dealers) during the period
  wholesaleSales Float?

  /// Wholesale year-over-year percentage change vs same period last year
  wholesaleYoy   Float?

  /// Wholesale change vs previous comparable period
  wholesaleMom   Float?

  /// Unit of measurement. Default: "vehicles"
  unit           String   @default("vehicles")

  /// Optional summary or context from the source article
  description    String?

  /// URL of the source article where data was extracted
  sourceUrl      String

  /// Title of the source article
  sourceTitle    String

  /// URL of any chart/image used for OCR extraction (if applicable)
  imageUrl       String?

  /// Record creation timestamp
  createdAt      DateTime @default(now())

  /// Last update timestamp
  updatedAt      DateTime @updatedAt

  @@unique([dataSource, year, startDate, endDate])
  @@index([year])
}

/// Monthly automaker sales rankings (top-selling car manufacturers).
/// Tracks competitive positioning of major automakers in China's auto market.
/// Rankings may be for overall sales or NEV-specific depending on the source article.
/// Major automakers: BYD, Geely, SAIC, Changan, GAC, Great Wall, NIO, Xpeng, Li Auto, etc.
/// Data frequency: Monthly
/// Primary source: CPCA (passenger), CAAM (all vehicles)
/// Use case: Competitive analysis, market share tracking, brand performance comparison
model AutomakerRankings {
  /// Unique identifier (CUID format)
  id            String   @id @default(cuid())

  /// Data source organization. Default: "CPCA"
  /// Values: "CPCA" (passenger cars), "CAAM" (all vehicles)
  dataSource    String   @default("CPCA")

  /// Calendar year (e.g., 2024, 2025)
  year          Int

  /// Month of the year (1-12, where 1=January, 12=December)
  month         Int

  /// Ranking position (1 = top seller, 2 = second, etc.)
  ranking       Int

  /// Automaker company name
  /// Examples: "BYD", "Geely", "SAIC", "Changan", "GAC", "Great Wall", "NIO", "Xpeng", "Li Auto"
  automaker     String

  /// Sales volume in number of vehicles
  value         Float

  /// Unit of measurement. Default: "vehicles"
  unit          String   @default("vehicles")

  /// Year-over-year percentage change (e.g., 25.5 means +25.5% vs same month last year)
  yoyChange     Float?

  /// Month-over-month percentage change (e.g., -10.2 means -10.2% vs previous month)
  momChange     Float?

  /// Market share as percentage (e.g., 15.5 means 15.5% of total market)
  marketShare   Float?

  /// Optional summary or context from the source article
  description   String?

  /// URL of the source article where data was extracted
  sourceUrl     String

  /// Title of the source article
  sourceTitle   String

  /// URL of any chart/image used for OCR extraction (if applicable)
  imageUrl      String?

  /// Record creation timestamp
  createdAt     DateTime @default(now())

  /// Last update timestamp
  updatedAt     DateTime @updatedAt

  @@unique([dataSource, year, month, automaker])
  @@index([dataSource])
  @@index([automaker])
  @@index([year, month])
}

/// Battery maker rankings (top battery manufacturers by market share).
/// Tracks competitive positioning in both China domestic and global battery markets.
/// China market dominated by CATL, BYD; global includes LG, SK, Panasonic, Samsung SDI.
/// Can be monthly snapshots, year-to-date (YTD), or yearly totals.
/// Data frequency: Monthly, quarterly, or yearly
/// Primary source: CABIA (China domestic), SNE Research (Global)
/// Use case: Battery industry competitive analysis, supply chain understanding, market share trends
model BatteryMakerRankings {
  /// Unique identifier (CUID format)
  id               String   @id @default(cuid())

  /// Data source organization
  /// Values: "CABIA" (China Automotive Battery Innovation Alliance - China data),
  ///         "SNE" (SNE Research - Global data)
  dataSource       String

  /// Geographic scope of the ranking
  /// Values: "CHINA" (China domestic market), "GLOBAL" (worldwide)
  scope            String

  /// Time period type. Default: "MONTHLY"
  /// Values: "MONTHLY" (single month), "YTD" (year-to-date cumulative), "YEARLY" (full year)
  periodType       String   @default("MONTHLY")

  /// Calendar year (e.g., 2024, 2025)
  year             Int

  /// Month of the year (1-12). Null for yearly period type.
  month            Int?

  /// Ranking position (1 = top seller, 2 = second, etc.)
  ranking          Int

  /// Battery maker company name
  /// Chinese: "CATL", "BYD", "CALB", "Gotion", "EVE", "Sunwoda"
  /// Global: "LG Energy Solution", "SK On", "Panasonic", "Samsung SDI"
  maker            String

  /// Installation volume in GWh
  value            Float

  /// Unit of measurement. Default: "GWh" (Gigawatt-hours)
  unit             String   @default("GWh")

  /// Year-over-year percentage change (e.g., 25.5 means +25.5% vs same period last year)
  yoyChange        Float?

  /// Market share as percentage (e.g., 35.2 means 35.2% of total market)
  marketShare      Float?

  /// Market share change vs previous month (e.g., +1.2 means gained 1.2 percentage points)
  shareVsPrevMonth Float?

  /// Optional summary or context from the source article
  description      String?

  /// URL of the source article where data was extracted
  sourceUrl        String

  /// Title of the source article
  sourceTitle      String

  /// URL of any chart/image used for OCR extraction (if applicable)
  imageUrl         String?

  /// Record creation timestamp
  createdAt        DateTime @default(now())

  /// Last update timestamp
  updatedAt        DateTime @updatedAt

  @@unique([dataSource, scope, year, month, maker])
  @@index([dataSource, scope])
  @@index([maker])
  @@index([year, month])
}
